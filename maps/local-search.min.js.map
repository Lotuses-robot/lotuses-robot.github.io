{"version":3,"sources":["local-search.js"],"names":["searchEscape","keyword","htmlEntityMap","replace","i","regEscape","regEntityMap","$","getParam","reqParam","results","RegExp","exec","window","location","decodeURIComponent","setNotice","type","info","searchInfo","document","getElementById","className","innerText","clearPosts","innerHTML","createPosts","resArr","resultSectionElement","resultString","forEach","resInfo","pageInfo","pageTags","tags","tag","postTagTemplate","concat","postTemplate","category","link","title","content","date","loadDataSearch","searchDataFile","skeys","fetch","then","res","NProgress","inc","json","datas","startTime","performance","now","resultArray","resultCount","keywords","trim","toLowerCase","split","data","matched","dataTitle","dataContent","dataWeight","indexs","halfLenth","indexOf","firstOccur","lastOccur","tPage","Date","toLocaleDateString","categories","url","regS","start","end","length","substr","push","finishTime","Math","round","sort","a","b","done","catch","error","keySearch","inpSearch","value","history","pushState","href"],"mappings":"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","file":"../js/local-search.min.js","sourcesContent":["function searchEscape(keyword) {\n    const htmlEntityMap = {\n        '&': '&amp;',\n        '<': '&lt;',\n        '>': '&gt;',\n        '\"': '&quot;',\n        '\\'': '&#39;',\n        '/': '&#x2F;'\n    };\n\n    return keyword.replace(/[&<>\"'/]/g, function (i) {\n        return htmlEntityMap[i];\n    });\n}\n\nfunction regEscape(keyword) {\n    const regEntityMap = {\n        '{': '\\\\\\{',\n        '}': '\\\\\\}',\n        '[': '\\\\\\[',\n        ']': '\\\\\\]',\n        '(': '\\\\\\(',\n        ')': '\\\\\\)',\n        '?': '\\\\\\?',\n        '*': '\\\\\\*',\n        '.': '\\\\\\.',\n        '+': '\\\\\\+',\n        '^': '\\\\\\^',\n        '$': '\\\\\\$'\n    };\n\n    return keyword.replace(/[\\{\\}\\[\\]\\(\\)\\?\\*\\.\\+\\^\\$]/g, function (i) {\n        return regEntityMap[i];\n    });\n}\n\nfunction getParam(reqParam) {\n    // 获取参数\n    reqParam = reqParam.replace(/[\\[]/, \"\\\\\\[\").replace(/[\\]]/, \"\\\\\\]\");\n    const paraReg = new RegExp('[\\\\?&]' + reqParam + '=([^&#]*)');\n    const results = paraReg.exec(window.location);\n    return results === null ? '' : decodeURIComponent(results[1].replace(/\\+/g, ' '));\n}\n\nfunction setNotice(type, info) {\n    const searchInfo = document.getElementById('kr-search-notice');\n    searchInfo.className = 'alert alert-' + type;\n    searchInfo.innerText = info;\n}\n\nfunction clearPosts() {\n    const resultSectionElement = document.getElementById('result-posts');\n    resultSectionElement.innerHTML = '';\n}\n\nfunction createPosts(resArr) {\n    const resultSectionElement = document.getElementById('result-posts');\n    let resultString = '';\n\n    resArr.forEach((resInfo)=>{\n        const pageInfo = resInfo[0];\n        let pageTags = '';\n        pageInfo.tags.forEach((tag, i)=>{\n            pageTags += i ? ', ' : '';\n            const postTagTemplate = `<a class=\"tag-link\" href=\"${tag[1]}\" rel=\"tag\">${tag[0]}</a>`;\n            pageTags += postTagTemplate;\n        });\n        const postTemplate = `\n        <article class=\"kratos-hentry clearfix\">\n            <div class=\"kratos-entry-border-new clearfix\">\n                <div class=\"kratos-post-inner-new kr-search-result\">\n                    <header class=\"kratos-entry-header-new\">\n                        ${ pageInfo.category[0]!=='undefined' ? `<a class=\"label-link\" href=\"${pageInfo.category[1]}\">${pageInfo.category[0]}</a>` : '' }\n                        <h2 class=\"kratos-entry-title-new\"><a href=\"${pageInfo.link}\">${pageInfo.title}</a></h2>\n                    </header>\n                    <div class=\"kratos-entry-content-new\">\n                        <p>...${pageInfo.content}...</p>\n                    </div>\n                </div>\n                <div class=\"kratos-post-meta-new\">\n                    <span class=\"pull-left\">\n                        <a><i class=\"fa fa-calendar\"></i></a><a>${pageInfo.date}</a>\n                        <a><i class=\"fa fa-tags\"></i></a>\n                        ${pageTags}\n                    </span>\n                </div>\n            </div>\n        </article>\n        `;\n\n        resultString += postTemplate;\n    });\n    resultSectionElement.innerHTML = resultString;\n}\n\nfunction loadDataSearch(searchDataFile, skeys) {\n    fetch(searchDataFile)\n        .then((res)=>{\n            setNotice('success', '文件加载完成，开始搜索啦~');\n            if (typeof NProgress !== 'undefined') {\n                NProgress.inc();\n            }\n            return res.json();\n        })\n        .then((datas)=>{\n            const startTime = performance.now();\n            let resultArray = [];\n            let resultCount = 0;\n            let keywords = skeys.trim().toLowerCase().split(/\\s/);\n\n            datas.forEach((data)=>{\n                if (typeof data.title === 'undefined' || typeof data.content === 'undefined') {\n                    return;\n                }\n\n                // 开始匹配\n                let matched = false;\n\n                const dataTitle      = data.title.trim().toLowerCase();\n                const dataContent    = data.content ? data.content.trim().replace(/<[^>]+>/g, '').toLowerCase() : '';\n                let   dataWeight     = 0;\n\n                let indexs = {};\n                indexs.title        = -1;\n                indexs.content      = -1;\n                indexs.firstOccur   = -1;\n                indexs.lastOccur    = -1;\n                const halfLenth = 100;\n\n                if (dataTitle) {\n                    keywords.forEach((keyword)=>{\n                        indexs.title = dataTitle.indexOf(keyword);\n                        indexs.content = dataContent.indexOf(keyword);\n                        if (indexs.title !== -1 || indexs.content !== -1) {\n                            matched = true;\n                            if (indexs.content !== -1) {\n                                if (indexs.firstOccur > indexs.content || indexs.firstOccur === -1) {\n                                    indexs.firstOccur = indexs.content;\n                                }\n                                if (indexs.lastOccur < indexs.content) {\n                                    indexs.lastOccur = indexs.content;\n                                }\n                            } else {\n                                //命中 title，但正文 conten 未命中时\n                                indexs.firstOccur = halfLenth;\n                                indexs.lastOccur = 0;\n                            }\n                            dataWeight += indexs.title   !== -1 ? 2 : 0;\n                            dataWeight += indexs.content !== -1 ? 1 : 0;\n                            resultCount++;\n                        }\n                    });\n                }\n\n                // 设置高亮\n                if (matched) {\n                    let tPage = {};\n                    tPage.title = data.title;\n                    tPage.date = new Date(data.date).toLocaleDateString();\n                    tPage.tags = data.tags || [];\n                    tPage.category = data.categories[0] || [];\n                    tPage.link = data.url;\n                    keywords.forEach((keyword)=>{\n                        const regS = new RegExp(regEscape(keyword) + '(?!>)', 'gi');\n                        tPage.title = tPage.title.replace(regS, '<m>$&</m>');\n                    });\n                    if (indexs.firstOccur >= 0) {\n                        //const halfLenth = 100;\n                        let start = indexs.firstOccur - halfLenth;\n                        let end   = indexs.lastOccur + halfLenth;\n                        if (start < 0) {\n                            start = 0;\n                        }\n                        if (start === 0) {\n                            end = halfLenth * 2;\n                        }\n                        if (end > dataContent.length) {\n                            end = dataContent.length;\n                        }\n                        tPage.content = dataContent.substr(start, end-start);\n                        keywords.forEach((keyword)=>{\n                            const regS = new RegExp(regEscape(keyword) + '(?!>)', 'gi');\n                            tPage.content = tPage.content.replace(regS, '<m>$&</m>');\n                        });\n                    }\n                    resultArray.push([tPage, dataWeight]);\n                }\n\n            });\n            if (resultCount !== 0) {\n                const finishTime = performance.now();\n                setNotice('success', '找到 ' + resultCount + ' 条搜索结果，用时 ' + Math.round((finishTime - startTime)*100)/100 + ' 毫秒~');\n                resultArray.sort((a, b)=>{\n                    return b[1] - a[1];\n                });\n                createPosts(resultArray);\n            } else {\n                setNotice('danger', '什么都没有找到欸...');\n                clearPosts();\n            }\n            if (typeof NProgress !== 'undefined') {\n                NProgress.done();\n            }\n        })\n        .catch((error)=>{\n            setNotice('danger', '错误 : ' + error);\n        });\n}\n\nfunction keySearch(skeys) {\n    // 设置搜索提示\n    setNotice('info', '正在加载搜索文件...');\n\n    // 启动进度条\n    if (typeof NProgress !== 'undefined') {\n        NProgress.start();\n    }\n\n    // 加载数据并搜索\n    loadDataSearch(searchDataFile, searchEscape(skeys));\n}\n\nfunction inpSearch() {\n    // 单击按钮检索\n    const skeys = document.getElementById('search-input').value;\n    // 更新URL\n    window.history.pushState({},0,window.location.href.split('?')[0]+'?s=' + skeys.replace(/\\s/g, '+'));\n    // 开始搜索\n    keySearch(skeys);\n    return false;\n}\n\n(()=>{\n    const skeys = getParam('s');\n    if (skeys !== '') {\n        // 存在关键词，把搜索词放到输入框里面\n        document.getElementById('search-input').value = skeys;\n        // 开始搜索\n        keySearch(skeys);\n    }\n})();"]}